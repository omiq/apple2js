<!DOCTYPE html>
<!--
 Copyright 2010-2021 Will Scullin and contributors

 Permission to use, copy, modify, distribute, and sell this software and its
 documentation for any purpose is hereby granted without fee, provided that
 the above copyright notice appear in all copies and that both that
 copyright notice and this permission notice appear in supporting
 documentation.  No representations are made about the suitability of this
 software for any purpose.  It is provided "as is" without express or
 implied warranty.
-->
<html>
<head>

<title>Apple //jse - An Apple //e Emulator in JavaScript</title>

<meta name="viewport" content="width=640, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Apple //jse">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta charset="utf-8" />
<meta name="description" content="Apple //jse is an Apple //e emulator written using only JavaScript and HTML5. It has color display, sound and disk support." />
<meta name="keywords" content="apple2e,apple,ii,javascript,emulator,html5" />

<link rel="apple-touch-icon" href="img/webapp-iphone.png" />
<link rel="apple-touch-icon" size="72x72" href="img/webapp-ipad.png" />
<link rel="shortcut icon" href="img/logoicon.png" />
<link rel="stylesheet" type="text/css" href="css/apple2.css" />
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.2/css/all.css" />

<!-- Disk Index -->
<script type="text/javascript" src="json/disks/index.js"></script>

</head>
<body class="apple2e"
      ondragover="Apple2.handleDragOver(0, event)"
      ondrop="Apple2.handleDrop(0, event)"
      ondragend="Apple2.handleDragEnd(0, event)">
  <div class="outer">
    <div id="exit-fullscreen">
      <button onClick="Apple2.exitFullScreen();">Exit Full Page</button>
    </div>
    <!-- <div id="header">
      <a href="https://github.com/whscullin/apple2js#readme" target="_blank">
        <img src="img/badge2e.png" id="badge" />
      </a>
      <div id="subtitle">An Apple //e Emulator in JavaScript</div>
    </div> -->
    <div id="display">
      <div class="overscan">
        <canvas id="screen" width="592" height="416" tabindex="-1"></canvas>
      </div>
    </div>
    <div class="inset">
      <div class="disk"
           ondragover="Apple2.handleDragOver(1, event)"
           ondrop="Apple2.handleDrop(1, event)"
           ondragend="Apple2.handleDragEnd(1, event)">
        <div class="disk-light" id="disk1"></div>
        <button title="Load Disk"
                onclick="Apple2.openLoad(1, event);">
          <i class="fas fa-folder-open"></i>
        </button>
        <button title="Save Disk"
                onclick="Apple2.openSave(1, event);">
          <i class="fas fa-save"></i>
        </button>
        <div id="disk-label1" class="disk-label">Disk 1</div>
      </div>
      <div class="disk"
           ondragover="Apple2.handleDragOver(2, event)"
           ondrop="Apple2.handleDrop(2, event)"
           ondragend="Apple2.handleDragEnd(2, event)">
        <div class="disk-light" id="disk2"></div>
        <button title="Load Disk"
                onclick="Apple2.openLoad(2, event);">
          <i class="fas fa-folder-open"></i>
        </button>
        <button title="Save Disk"
                onclick="Apple2.openSave(2, event);">
          <i class="fas fa-save"></i>
        </button>
        <div id="disk-label2" class="disk-label">Disk 2</div>
      </div>
    </div>
    <div id="reset-row">
      <div id="controls" class="inset">
        <div id="khz" onclick="Apple2.toggleShowFPS()">0 kHz</div>
        <button id="pause-run" onclick="Apple2.pauseRun()" title="Pause/Run">
          <i class="fas fa-pause"></i>
        </button>
        <button id="toggle-sound" onclick="Apple2.toggleSound()" title="Toggle Sound">
          <i class="fas fa-volume-off"></i>
        </button>
        <button id="toggle-printer" onclick="Apple2.openPrinterModal()" title="Toggle Printer">
          <i class="fas fa-print"></i>
        </button>
        <div class="spacer short"></div>
        <button onclick="Apple2.copy()" title="Copy">
          <i class="fas fa-copy"></i>
        </button>
        <button onclick="Apple2.paste()" title="Paste">
          <i class="fas fa-paste"></i>
        </button>
          <div class="spacer"></div>
        <button onclick="window.open('https://github.com/whscullin/apple2js#readme', 'blank')" title="About">
          <i class="fas fa-info"></i>
        </button>
        <button onclick="Apple2.openOptions()" title="Options (F4)">
          <i class="fas fa-cog"></i>
        </button>
      </div>
      <div id="reset" type="button"
        onclick="Apple2.reset(event)"
        oncontextmenu="Apple2.reset(event)">
        Reset
      </div>
    </div>
    <div class="inset">
      <div id="keyboard"></div>
    </div>
  </div>

  <div class="modal" id="loading-modal" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
      <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="Loading" >
        <header class="modal__header">
          <div class="modal__title" id="loading-modal-title">
            Loading...
          </div>
        </header>
        <main class="modal__content" id="loading-modal-content">
          <div class="meter">
            <div class="progress"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="options-modal" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
      <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="Options">
        <header class="modal__header">
          <span class="modal__title" id="options-modal-title">
            Options
          </span>
          <button class="modal__close" aria-label="Close modal" data-micromodal-close>
          </button>
        </header>
        <main class="modal__content" id="options-modal-content">
        </main>
        <footer class="modal__footer">
          <button class="modal__btn" data-micromodal-close aria-label="Close this dialog window">Close</button>
        </footer>
      </div>
    </div>
  </div>

  <div class="modal" id="save-modal" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
      <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="Save Disk">
        <header class="modal__header">
          <span class="modal__title" id="save-modal-title">
            Save Disk
          </span>
          <button class="modal__close" aria-label="Close modal" data-micromodal-close>
          </button>
        </header>
        <main class="modal__content" id="save-modal-content">
          <form action="#" onsubmit="return false;">
            <h3>Save to Browser</h3>
            Save Name: <input type="text" name="name" id="save_name" />
            <button class="modal__btn" onclick="Apple2.doSave()" aria-label="Save disk locally">Save</button>
          </form>
          <hr />
          <div>
            <h3>Download to Local Disk</h3>
          </div>
        </main>
        <footer class="modal__footer">
          <a id="local_save_link" class="button">Download</a>
        </footer>
      </div>
    </div>
  </div>

  <div class="modal" id="manage-modal" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
      <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="Load Disk">
        <header class="modal__header">
          <span class="modal__title" id="manage-modal-title">
            Manage Local Saves
          </span>
          <button class="modal__close" aria-label="Close modal" data-micromodal-close>
          </button>
        </header>
        <main class="modal__content" id="manage-modal-content">
        </main>
        <footer class="modal__footer">
          <button class="modal__btn" data-micromodal-close aria-label="Close this dialog window">OK</button>
        </footer>
      </div>
    </div>
  </div>

  <div class="modal" id="http-modal" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
      <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="Load Disk">
        <header class="modal__header">
          <span class="modal__title" id="http-modal-title">
            Load URL
          </span>
          <button class="modal__close" aria-label="Close modal" data-micromodal-close>
          </button>
        </header>
        <main class="modal__content" id="http-modal-content">
          <form action="#">
            <input type="text" id="http_url" />
          </form>
        </main>
        <footer class="modal__footer">
          <button class="modal__btn" data-micromodal-close aria-label="Load this URL">OK</button>
        </footer>
      </div>
    </div>
  </div>

  <div class="modal" id="load-modal" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
      <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="Load Disk">
        <header class="modal__header">
          <span class="modal__title" id="load-modal-title">
            Load Disk
          </span>
          <button class="modal__close" aria-label="Close modal" data-micromodal-close>
          </button>
        </header>
        <main class="modal__content" id="load-modal-content">
          <table>
            <tr>
              <td>
                <select id="category_select" multiple="multiple"
                        onchange="Apple2.selectCategory(event)" >
                </select>
              </td>
              <td>
                <select id="disk_select" multiple="multiple"
                        onchange="Apple2.selectDisk(event)"
                        ondblclick="Apple2.clickDisk(event)">
                </select>
              </td>
            </tr>
          </table>
          <form action="#">
            <input type="file" id="local_file" />
            <div id="local_file_address_input" style="display: none">
              $
              <input id="local_file_address" />
            </div>
          </form>
        </main>
        <footer class="modal__footer">
          <button class="modal__btn" data-micromodal-close aria-label="Close this dialog window">Cancel</button>
          <button class="modal__btn" onclick="Apple2.doLoad(event)" aria-label="Open the selected disk">Open</button>
        </footer>
      </div>
    </div>
  </div>

  <div class="modal" id="printer-modal" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
      <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="Printer">
        <header class="modal__header">
          <span class="modal__title" id="printer-modal-title">
              Printer
          </span>
          <button class="modal__close" aria-label="Close modal" data-micromodal-close>
          </button>
        </header>
        <main class="modal__content" id="printer-modal-content">
          <div class="paper" tabindex="-1"></div>
        </main>
        <footer class="modal__footer">
          <a id="raw_printer_output" class="button">Download Raw Output</a>
          <button class="modal__btn" onclick="Apple2.clearPrinterPaper()" aria-label="Clear the paper">Clear</button>
          <button class="modal__btn" data-micromodal-close aria-label="Close this dialog window">Close</button>
        </footer>
      </div>
    </div>
  </div>

  <div class="modal" id="alert-modal" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
      <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="Alert">
        <header class="modal__header">
          <span class="modal__title" id="alert-modal-title">
              Alert
          </span>
          <button class="modal__close" aria-label="Close modal" data-micromodal-close>
          </button>
        </header>
        <main class="modal__content" id="alert-modal-content">
          <div class="message">
          </div>
        </main>
        <footer class="modal__footer">
          <button class="modal__btn" data-micromodal-close aria-label="Close this dialog window">Close</button>
        </footer>
      </div>
    </div>
  </div>

  <svg width="0" height="0" xmlns="http://www.w3.org/2000/svg">
    <filter id="green">
      <feColorMatrix
        type="matrix"
        values="0.0 0.0 0.0 0.0 0
                0.0 1.0 0.0 0.0 0
                0.0 0.0 0.5 0.0 0
                0.0 0.0 0.0 1.0 0"
      />
      </filter>
  </svg>

  <script src="dist/main2e.bundle.js"></script>
  <script>
    // Ensure canvas can receive focus and keyboard input
    function setupKeyboardInput() {
      const canvas = document.getElementById('screen');
      if (!canvas) return;
      
      // Make canvas focusable
      canvas.setAttribute('tabindex', '0');
      canvas.style.outline = 'none';
      
      // Focus canvas on click
      canvas.addEventListener('click', () => {
        canvas.focus();
      });
      
      // Forward keyboard events to emulator (including control keys)
      function handleKeyDown(e) {
        if (!window.apple2 || !window.apple2.getIO) return;
        const io = window.apple2.getIO();
        if (!io) return;
        
        // Map special keys to Apple II key codes
        const keyMap = {
          'Enter': 13,
          'Escape': 27,
          'Backspace': 127,
          'Delete': 127,
          'ArrowLeft': 8,   // Left arrow = BS
          'ArrowRight': 21, // Right arrow = CTRL-U
          'ArrowUp': 11,    // Up arrow = CTRL-K
          'ArrowDown': 10,  // Down arrow = CTRL-J
          'Tab': 9,
          'Home': 1,
          'End': 5,
          'PageUp': 11,
          'PageDown': 10
        };
        
        const appleKeyCode = keyMap[e.key];
        
        if (appleKeyCode !== undefined) {
          io.keyDown(appleKeyCode);
          e.preventDefault();
          e.stopPropagation();
        } else if (e.key.length === 1) {
          // Printable character
          const charCode = e.key.charCodeAt(0);
          if (charCode >= 32 && charCode <= 126) {
            io.setKeyBuffer(charCode);
            e.preventDefault();
            e.stopPropagation();
          }
        }
      }
      
      function handleKeyUp(e) {
        if (!window.apple2 || !window.apple2.getIO) return;
        const io = window.apple2.getIO();
        if (!io) return;
        
        const keyMap = {
          'Enter': 13,
          'Escape': 27,
          'Backspace': 127,
          'Delete': 127,
          'ArrowLeft': 8,
          'ArrowRight': 21,
          'ArrowUp': 11,
          'ArrowDown': 10,
          'Tab': 9,
          'Home': 1,
          'End': 5,
          'PageUp': 11,
          'PageDown': 10
        };
        
        const appleKeyCode = keyMap[e.key];
        if (appleKeyCode !== undefined) {
          io.keyUp(appleKeyCode);
          e.preventDefault();
          e.stopPropagation();
        }
      }
      
      canvas.addEventListener('keydown', handleKeyDown);
      canvas.addEventListener('keyup', handleKeyUp);
    }
    
    // Handle messages from parent (pause/resume/reset)
    window.addEventListener('message', (event) => {
      if (event.source !== window.parent) return;
      
      console.log('Apple2JS: Received message:', event.data.type);
      
      // Wait for emulator to be ready
      if (!window.apple2) {
        // Try to get it from Apple2 namespace
        if (window.Apple2 && window.Apple2.apple2) {
          window.apple2 = window.Apple2.apple2;
        } else {
          console.log('Apple2JS: Emulator not ready yet');
          return; // Emulator not ready yet
        }
      }
      
      if (!window.apple2) {
        console.log('Apple2JS: window.apple2 is still not available');
        return;
      }
      
      switch (event.data.type) {
        case 'pause':
        case 'stop':
          console.log('Apple2JS: Pausing emulator');
          if (typeof window.apple2.isRunning === 'function' && window.apple2.isRunning()) {
            window.apple2.stop();
            console.log('Apple2JS: Emulator paused');
          } else if (typeof window.apple2.stop === 'function') {
            window.apple2.stop();
            console.log('Apple2JS: Emulator stopped (isRunning not available)');
          } else {
            console.log('Apple2JS: stop() method not available');
          }
          break;
        case 'resume':
        case 'run':
          console.log('Apple2JS: Resuming emulator');
          if (typeof window.apple2.run === 'function') {
            const isRunning = typeof window.apple2.isRunning === 'function' ? window.apple2.isRunning() : false;
            if (!isRunning) {
              window.apple2.run();
              console.log('Apple2JS: Emulator resumed');
            } else {
              console.log('Apple2JS: Emulator already running');
            }
          } else {
            console.log('Apple2JS: run() method not available');
          }
          break;
        case 'reset':
          console.log('Apple2JS: Resetting emulator with Open Apple + Reset');
          if (typeof window.apple2.reset === 'function') {
            const wasRunning = typeof window.apple2.isRunning === 'function' ? window.apple2.isRunning() : true;
            const io = window.apple2.getIO ? window.apple2.getIO() : null;
            
            // Press and hold Open Apple (button 0) before reset
            if (io && typeof io.buttonDown === 'function') {
              io.buttonDown(0, true); // Press Open Apple
              console.log('Apple2JS: Open Apple button pressed');
            }
            
            // Small delay to ensure button is registered
            setTimeout(() => {
              // Reset while holding Open Apple (this triggers boot from disk if disk is present)
              window.apple2.reset();
              console.log('Apple2JS: Emulator reset with Open Apple held');
              
              // Release Open Apple after reset
              if (io && typeof io.buttonDown === 'function') {
                setTimeout(() => {
                  io.buttonDown(0, false); // Release Open Apple
                  console.log('Apple2JS: Open Apple button released');
                }, 100);
              }
              
              // Ensure emulator continues running after reset
              if (wasRunning && typeof window.apple2.run === 'function') {
                setTimeout(() => {
                  if (typeof window.apple2.isRunning === 'function' && !window.apple2.isRunning()) {
                    window.apple2.run();
                    console.log('Apple2JS: Emulator restarted after reset');
                  } else if (typeof window.apple2.isRunning !== 'function') {
                    window.apple2.run();
                    console.log('Apple2JS: Emulator restarted after reset (isRunning not available)');
                  }
                }, 200);
              }
            }, 50);
          } else {
            console.log('Apple2JS: reset() method not available');
          }
          break;
      }
    });
    
    // Wait for emulator to be ready
    window.addEventListener('load', () => {
      const checkReady = setInterval(() => {
        if (window.Apple2 && window.Apple2.apple2) {
          clearInterval(checkReady);
          window.apple2 = window.Apple2.apple2;
          Promise.resolve(window.apple2.ready).then(() => {
            setupKeyboardInput();
          });
        }
      }, 100);
      
      setTimeout(() => clearInterval(checkReady), 10000);
    });
  </script>
</body>
</html>
